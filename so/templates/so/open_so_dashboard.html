{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Order Dashboard</title>
    
    <!-- Fonts (Inter for a modern look) -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&display=swap" rel="stylesheet">
    
    <!-- Bootstrap 5 -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    
    <!-- DataTables CSS -->
    <link href="https://cdn.datatables.net/1.13.4/css/dataTables.bootstrap5.min.css" rel="stylesheet">
    
    <!-- Select2 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/css/select2.min.css" rel="stylesheet" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/select2-bootstrap-5-theme@1.3.0/dist/select2-bootstrap-5-theme.min.css" />
    
    <!-- Bootstrap Icons -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.5/font/bootstrap-icons.css">

    <style>
        :root {
            --primary-color: #2563eb;
            --bg-color: #f3f4f6;
            --card-border: #e5e7eb;
            --text-main: #1f2937;
            --text-muted: #6b7280;
        }

        body { 
            background-color: var(--bg-color); 
            font-family: 'Inter', sans-serif; 
            color: var(--text-main);
            font-size: 0.9rem;
        }

        /* --- Modern Cards --- */
        .dashboard-card {
            background: white;
            border: 1px solid var(--card-border);
            border-radius: 12px;
            padding: 20px;
            box-shadow: 0 1px 3px rgba(0,0,0,0.05);
            height: 100%;
            transition: box-shadow 0.2s;
        }

        /* --- Header Section --- */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        .page-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: #111827;
        }

        /* --- Month Toolbar --- */
        .month-toolbar {
            display: flex;
            flex-wrap: wrap;
            gap: 4px;
        }
        .month-btn { 
            width: 40px; 
            height: 32px;
            font-size: 12px; 
            border: 1px solid #e5e7eb;
            background: white;
            color: var(--text-main);
            border-radius: 6px;
            transition: all 0.2s ease;
        }
        .month-btn:hover { background-color: #f9fafb; border-color: #d1d5db; }
        .month-btn.active { 
            background-color: #1f2937; 
            color: white; 
            border-color: #1f2937; 
            font-weight: 500;
        }

        /* --- Loading Overlay (Fixes Shaking) --- */
        .table-wrapper {
            position: relative;
            min-height: 400px; /* Prevent collapse */
        }
        .loading-overlay {
            position: absolute;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.7);
            backdrop-filter: blur(2px);
            z-index: 10;
            display: flex;
            justify-content: center;
            align-items: center;
            border-radius: 12px;
            opacity: 0;
            pointer-events: none;
            transition: opacity 0.2s ease;
        }
        .loading-overlay.show {
            opacity: 1;
            pointer-events: all;
        }

        /* --- Table Styling --- */
        table.dataTable thead th {
            background-color: #f9fafb;
            color: #374151;
            font-weight: 600;
            border-bottom: 2px solid #e5e7eb !important;
            font-size: 0.85rem;
            text-transform: uppercase;
            letter-spacing: 0.05em;
        }
        table.dataTable tbody td {
            vertical-align: middle;
            color: #4b5563;
            font-size: 0.9rem;
            border-color: #f3f4f6;
            padding: 12px 10px;
        }
        .fw-bold-num { font-weight: 600; color: #111827; }

        /* --- Custom Dropdowns (Power BI Style) --- */
        .pbi-toggle {
            text-align: left;
            background-color: #fff;
            border: 1px solid #dee2e6;
            width: 100%;
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 0.375rem 0.75rem;
            border-radius: 0.375rem;
            font-size: 0.9rem;
            color: #212529;
        }
        .pbi-toggle:focus { border-color: #86b7fe; box-shadow: 0 0 0 0.25rem rgba(13, 110, 253, 0.25); }
        .pbi-dropdown-menu { width: 100%; padding: 10px; max-height: 300px; overflow-y: auto; box-shadow: 0 10px 15px -3px rgba(0,0,0,0.1); border: 1px solid #f3f4f6; }
        .pbi-search-box { margin-bottom: 10px; font-size: 0.85rem; padding: 6px 10px; }
        .pbi-checkbox-item { padding: 6px 8px; border-radius: 4px; font-size: 0.9rem; }
        .pbi-checkbox-item:hover { background-color: #f3f4f6; }
        .pbi-checkbox-item label { width: 100%; cursor: pointer; display: flex; align-items: center; margin: 0; }
        .pbi-checkbox-item input { margin-right: 10px; width: 16px; height: 16px; accent-color: var(--primary-color); }
        
        /* Select2 Tweaks */
        .select2-container--bootstrap-5 .select2-selection { border-color: #dee2e6; }
    </style>
</head>
<body>

<div class="container-fluid p-4">

    <!-- Header Section -->
    <div class="page-header">
        <div>
            <h1 class="page-title">Open Sales Order Dashboard</h1>
            <p class="text-muted mb-0" style="font-size: 0.85rem;">View and filter open sales orders by customer, item, and date.</p>
        </div>
        
        {% if user.role.role == 'Admin' %}
        <div class="d-flex gap-2">
            <a href="{% url 'upload_so_data' %}" class="btn btn-outline-primary btn-sm d-flex align-items-center">
                <i class="bi bi-upload me-2"></i> Upload File
            </a>
            <button type="button" id="btnExportPdf" class="btn btn-danger btn-sm d-flex align-items-center">
                <i class="bi bi-file-earmark-pdf me-2"></i> Export PDF
            </button>
        </div>
        {% endif %}
    </div>

    <!-- Month Filter Bar -->
    <div class="dashboard-card mb-3 p-3">
        <div class="d-flex align-items-center flex-wrap gap-3">
            <div class="fw-bold text-uppercase text-muted" style="font-size: 0.75rem; letter-spacing: 0.05em;">Filter by Month:</div>
            <div class="month-toolbar">
                <button class="month-btn" data-month="1">Jan</button>
                <button class="month-btn" data-month="2">Feb</button>
                <button class="month-btn" data-month="3">Mar</button>
                <button class="month-btn" data-month="4">Apr</button>
                <button class="month-btn" data-month="5">May</button>
                <button class="month-btn" data-month="6">Jun</button>
                <button class="month-btn" data-month="7">Jul</button>
                <button class="month-btn" data-month="8">Aug</button>
                <button class="month-btn" data-month="9">Sep</button>
                <button class="month-btn" data-month="10">Oct</button>
                <button class="month-btn" data-month="11">Nov</button>
                <button class="month-btn" data-month="12">Dec</button>
            </div>
            <div class="ms-auto">
                <button class="btn btn-light btn-sm text-muted" id="resetFilters" style="font-size: 0.8rem;">
                    <i class="bi bi-arrow-counterclockwise"></i> Reset Filters
                </button>
            </div>
        </div>
    </div>

    <!-- Filters Grid -->
    <div class="row g-3 mb-4">
        <!-- 1. Category (HO/Others) -->
        <div class="col-md-2">
            <div class="dashboard-card p-3 d-flex flex-column justify-content-center">
                <label class="fw-bold text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Category</label>
                <div class="form-check">
                    <input class="form-check-input filter-trigger" type="checkbox" id="checkHO" checked>
                    <label class="form-check-label small" for="checkHO">HO (Doc starts '1')</label>
                </div>
                <div class="form-check">
                    <input class="form-check-input filter-trigger" type="checkbox" id="checkOthers" checked>
                    <label class="form-check-label small" for="checkOthers">Others</label>
                </div>
            </div>
        </div>

        <!-- 2. Salesman -->
        <div class="col-md-3">
            <div class="dashboard-card p-3">
                <label class="fw-bold text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Salesman</label>
                <div class="dropdown">
                    <button class="btn pbi-toggle" type="button" id="salesmanDropdownBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                        <span>All Selected</span> <i class="bi bi-chevron-down ms-2" style="font-size: 0.8em;"></i>
                    </button>
                    <div class="dropdown-menu pbi-dropdown-menu">
                        <input type="text" class="form-control pbi-search-box" placeholder="Search..." onkeyup="filterList(this)">
                        <div class="pbi-checkbox-item border-bottom mb-2 pb-2">
                            <label><input type="checkbox" class="select-all-checkbox" data-target="salesman-checkbox"> <strong>Select All</strong></label>
                        </div>
                        <ul class="pbi-checkbox-list list-unstyled mb-0" id="salesmanList">
                            {% for s in salesmen %}
                                {% if s %}
                                <li class="pbi-checkbox-item">
                                    <label><input type="checkbox" class="filter-trigger salesman-checkbox" value="{{ s }}"> {{ s }}</label>
                                </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 3. Manufacturer -->
        <div class="col-md-3">
            <div class="dashboard-card p-3">
                <label class="fw-bold text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Manufacturer</label>
                <div class="dropdown">
                    <button class="btn pbi-toggle" type="button" id="mfgDropdownBtn" data-bs-toggle="dropdown" data-bs-auto-close="outside" aria-expanded="false">
                        <span>All Selected</span> <i class="bi bi-chevron-down ms-2" style="font-size: 0.8em;"></i>
                    </button>
                    <div class="dropdown-menu pbi-dropdown-menu">
                        <input type="text" class="form-control pbi-search-box" placeholder="Search..." onkeyup="filterList(this)">
                        <div class="pbi-checkbox-item border-bottom mb-2 pb-2">
                            <label><input type="checkbox" class="select-all-checkbox" data-target="mfg-checkbox"> <strong>Select All</strong></label>
                        </div>
                        <ul class="pbi-checkbox-list list-unstyled mb-0" id="mfgList">
                            {% for m in manufacturers %}
                                {% if m %}
                                <li class="pbi-checkbox-item">
                                    <label><input type="checkbox" class="filter-trigger mfg-checkbox" value="{{ m }}"> {{ m }}</label>
                                </li>
                                {% endif %}
                            {% endfor %}
                        </ul>
                    </div>
                </div>
            </div>
        </div>

        <!-- 4. Items -->
        <div class="col-md-4">
            <div class="dashboard-card p-3">
                <label class="fw-bold text-muted text-uppercase mb-2" style="font-size: 0.75rem;">Items</label>
                <select class="form-select" id="itemFilter" multiple>
                    {% for i in items %}
                        {% if i %}<option value="{{ i }}">{{ i }}</option>{% endif %}
                    {% endfor %}
                </select>
            </div>
        </div>
    </div>

    <!-- Data Table Card -->
    <div class="dashboard-card p-0 table-wrapper">
        <!-- Loading Overlay -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="text-center">
                <div class="spinner-border text-primary" role="status" style="width: 3rem; height: 3rem;"></div>
                <div class="mt-2 text-muted fw-bold">Updating Data...</div>
            </div>
        </div>

        <div class="p-3">
            <table id="mainTable" class="table table-hover w-100">
                <thead>
                    <tr>
                        <th>Posting Date</th>
                        <th>Document No.</th>
                        <th>Customer</th>
                        <th>Item No.</th>
                        <th>Description</th>
                        <th class="text-end">Total SO</th>
                        <th class="text-end">Open Qty</th>
                        <th class="text-end">DIP Stock</th>
                        <th class="text-end">Available</th>
                    </tr>
                </thead>
                <tbody id="tableBody">
                    {% include 'so/partials/so_table_body.html' %}
                </tbody>
            </table>
        </div>
    </div>

</div>

<!-- Scripts -->
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/jquery.dataTables.min.js"></script>
<script src="https://cdn.datatables.net/1.13.4/js/dataTables.bootstrap5.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/select2@4.1.0-rc.0/dist/js/select2.min.js"></script>

<script>
    // --- Utils: Filter List for Dropdowns ---
    function filterList(inputElement) {
        var filter = inputElement.value.toLowerCase();
        var list = inputElement.closest('.dropdown-menu').querySelector('.pbi-checkbox-list');
        var items = list.getElementsByTagName('li');
        for (var i = 0; i < items.length; i++) {
            var label = items[i].getElementsByTagName("label")[0];
            var txtValue = label.textContent || label.innerText;
            items[i].style.display = txtValue.toLowerCase().indexOf(filter) > -1 ? "" : "none";
        }
    }

    $(document).ready(function () {
        
        // --- 1. Init Select2 (Items) ---
        $('#itemFilter').select2({
            theme: 'bootstrap-5',
            placeholder: "Search & Select Items",
            allowClear: true,
            width: '100%',
            closeOnSelect: false
        });

        // --- 2. Init DataTable ---
        function initDataTable() {
            if ($.fn.DataTable.isDataTable('#mainTable')) {
                $('#mainTable').DataTable().destroy();
            }
            $('#mainTable').DataTable({
                "pageLength": 50,
                "ordering": true,
                "searching": true,
                "info": true,
                "lengthChange": false, // Clean up UI
                "language": {
                    "search": "",
                    "searchPlaceholder": "Search visible records..."
                },
                "dom": "<'row mb-2'<'col-sm-12'f>>" +
                       "<'row'<'col-sm-12'tr>>" +
                       "<'row mt-3'<'col-sm-12 col-md-5'i><'col-sm-12 col-md-7'p>>"
            });
        }
        initDataTable();

        // --- 3. UI: Update Dropdown Button Text ---
        function updateDropdownText(checkboxClass, btnId, defaultText) {
            var checkedCount = $('.' + checkboxClass + ':checked').length;
            var totalCount = $('.' + checkboxClass).length;
            var btnSpan = $('#' + btnId + ' span');

            if (checkedCount === 0) btnSpan.text("None Selected");
            else if (checkedCount === totalCount) btnSpan.text("All Selected");
            else if (checkedCount === 1) {
                var name = $('.' + checkboxClass + ':checked').parent().text().trim();
                btnSpan.text(name.substring(0, 15) + (name.length > 15 ? "..." : ""));
            } else {
                btnSpan.text(checkedCount + " Selected");
            }
        }

        // --- 4. Event Handlers ---

        // Select All Logic
        $('.select-all-checkbox').on('change', function() {
            var targetClass = $(this).data('target');
            $('.' + targetClass).prop('checked', $(this).is(':checked'));
            
            // Trigger UI Update for button text
            if(targetClass.includes('salesman')) updateDropdownText('salesman-checkbox', 'salesmanDropdownBtn');
            if(targetClass.includes('mfg')) updateDropdownText('mfg-checkbox', 'mfgDropdownBtn');
            
            fetchFilteredData();
        });

        // Month Selection
        $('.month-btn').on('click', function() {
            $(this).toggleClass('active');
            fetchFilteredData();
        });

        // Dropdown/Checkbox Changes
        $(document).on('change', '.filter-trigger', function() {
            if ($(this).hasClass('salesman-checkbox')) updateDropdownText('salesman-checkbox', 'salesmanDropdownBtn');
            if ($(this).hasClass('mfg-checkbox')) updateDropdownText('mfg-checkbox', 'mfgDropdownBtn');
            fetchFilteredData();
        });

        $('#itemFilter').on('change', function() {
            fetchFilteredData();
        });

        // Reset Filters Button
        $('#resetFilters').on('click', function() {
            $('.month-btn').removeClass('active');
            $('.filter-trigger').prop('checked', true); // Reset checkboxes to all checked
            $('#itemFilter').val(null).trigger('change');
            
            // Reset UI text
            updateDropdownText('salesman-checkbox', 'salesmanDropdownBtn');
            updateDropdownText('mfg-checkbox', 'mfgDropdownBtn');
            
            fetchFilteredData();
        });

        // --- 5. Main Fetch Function (Stable Update) ---
        function fetchFilteredData() {
            // Collect Data
            var selectedMonths = $('.month-btn.active').map((_, el) => $(el).data('month')).get();
            var items = $('#itemFilter').val();
            var salesmen = $('.salesman-checkbox:checked').map((_, el) => $(el).val()).get();
            var manufacturers = $('.mfg-checkbox:checked').map((_, el) => $(el).val()).get();
            var showHO = $('#checkHO').is(':checked');
            var showOthers = $('#checkOthers').is(':checked');

            // --- STABILITY FIX: Lock Height & Show Overlay ---
            var container = $('.table-wrapper');
            container.css('min-height', container.height() + 'px'); // Lock current height
            $('#loadingOverlay').addClass('show');

            $.ajax({
                url: "{% url 'open_so_dashboard' %}",
                type: "GET",
                traditional: true,
                data: {
                    'salesman': salesmen,
                    'manufacturer': manufacturers,
                    'item': items,
                    'month': selectedMonths,
                    'show_ho': showHO,
                    'show_others': showOthers
                },
                success: function(response) {
                    // Destroy DataTables, replace HTML, Re-init
                    if ($.fn.DataTable.isDataTable('#mainTable')) {
                        $('#mainTable').DataTable().destroy();
                    }
                    
                    $('#tableBody').html(response);
                    
                    initDataTable();
                    
                    // --- Cleanup ---
                    setTimeout(() => {
                        $('#loadingOverlay').removeClass('show');
                        container.css('min-height', '400px'); // Release specific lock, keep min
                    }, 100); // Slight delay for smoother visual
                },
                error: function(xhr) {
                    console.error("Error:", xhr);
                    $('#loadingOverlay').removeClass('show');
                }
            });
        }

        // --- Export PDF ---
        $('#btnExportPdf').on('click', function() {
            var params = new URLSearchParams();
            if ($('#checkHO').is(':checked')) params.append('show_ho', 'true'); else params.append('show_ho', 'false');
            if ($('#checkOthers').is(':checked')) params.append('show_others', 'true'); else params.append('show_others', 'false');
            
            $('.month-btn.active').each(function() { params.append('month', $(this).data('month')); });
            $('.salesman-checkbox:checked').each(function() { params.append('salesman', $(this).val()); });
            $('.mfg-checkbox:checked').each(function() { params.append('manufacturer', $(this).val()); });
            
            var items = $('#itemFilter').val();
            if (items) items.forEach(i => params.append('item', i));

            window.open("{% url 'export_so_pdf' %}?" + params.toString(), '_blank');
        });
    });
</script>

</body>
</html>