{% load humanize %}
{% if items %}
  {% for item in items %}
  <tr class="item-row" data-search="{{ item.item_code|lower }} {{ item.item_description|lower }} {{ item.upc_code|lower }}">
    <td class="expand-cell">
      <button type="button" class="expand-btn" aria-label="Expand row">
        <i class="fas fa-chevron-right"></i>
      </button>
    </td>
    <td class="item-code">{{ item.item_code|default:"—" }}</td>
    <td class="item-description" title="{{ item.item_description|default:'Unknown' }}">{{ item.item_description|default:"Unknown" }}</td>
    <td class="upc-code">{{ item.upc_code|default:"—" }}</td>
    <td class="text-right num">
      {% if item.total_stock > 0 %}
        <span class="badge badge-blue">{{ item.total_stock|floatformat:0|intcomma }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">—</span>
      {% endif %}
    </td>
    <td class="text-right num">
      {% if item.import_ordered > 0 %}
        <span class="badge badge-red">{{ item.import_ordered|floatformat:0|intcomma }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">—</span>
      {% endif %}
    </td>
    <td class="text-right num">
      {% if item.qty_quoted_2025 > 0 %}
        <span class="badge badge-blue">{{ item.qty_quoted_2025|floatformat:0|intcomma }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">—</span>
      {% endif %}
    </td>
    <td class="text-right num">
      {% if item.qty_quoted_2026 > 0 %}
        <span class="badge badge-green">{{ item.qty_quoted_2026|floatformat:0|intcomma }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">—</span>
      {% endif %}
    </td>
    <td class="text-center">
      {% if item.total_quotations_2025 > 0 %}
        <span class="badge badge-blue">{{ item.total_quotations_2025 }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">0</span>
      {% endif %}
    </td>
    <td class="text-center">
      {% if item.total_quotations_2026 > 0 %}
        <span class="badge badge-purple">{{ item.total_quotations_2026 }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">0</span>
      {% endif %}
    </td>
    <td class="text-center">
      {% if item.customer_quoted_count > 0 %}
        <span class="badge badge-green" style="cursor: pointer;" title="Click row to see customer details">{{ item.customer_quoted_count }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">0</span>
      {% endif %}
    </td>
    {% if include_conversion %}
    <td class="text-right num conversion-cell conversion-cell-first">
      {% if item.so_qty_from_converted_2025 > 0 %}
        <span class="badge badge-purple">{{ item.so_qty_from_converted_2025|floatformat:0|intcomma }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">—</span>
      {% endif %}
    </td>
    <td class="text-right num conversion-cell">
      {% if item.so_qty_from_converted_2026 > 0 %}
        <span class="badge badge-purple">{{ item.so_qty_from_converted_2026|floatformat:0|intcomma }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">—</span>
      {% endif %}
    </td>
    <td class="text-center conversion-cell">
      {% if item.converted_quotation_count_2025 > 0 %}
        <span class="badge badge-amber">{{ item.converted_quotation_count_2025 }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">0</span>
      {% endif %}
    </td>
    <td class="text-center conversion-cell">
      {% if item.converted_quotation_count_2026 > 0 %}
        <span class="badge badge-amber">{{ item.converted_quotation_count_2026 }}</span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">0</span>
      {% endif %}
    </td>
    <!-- <td class="text-right num">
      {% if item.conversion_rate_2025 > 0 %}
        <span class="badge {% if item.conversion_rate_2025 >= 50 %}badge-success{% elif item.conversion_rate_2025 >= 25 %}badge-warning{% else %}badge-danger{% endif %}">
          {{ item.conversion_rate_2025|floatformat:1 }}%
        </span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">—</span>
      {% endif %}
    </td>
    <td class="text-right num">
      {% if item.conversion_rate_2026 > 0 %}
        <span class="badge {% if item.conversion_rate_2026 >= 50 %}badge-success{% elif item.conversion_rate_2026 >= 25 %}badge-warning{% else %}badge-danger{% endif %}">
          {{ item.conversion_rate_2026|floatformat:1 }}%
        </span>
      {% else %}
        <span style="color: var(--text-muted); font-size: 0.7rem;">—</span>
      {% endif %}
    </td> -->
    {% endif %}
  </tr>
  <tr class="customer-details">
    <td colspan="{% if include_conversion %}16{% else %}10{% endif %}">
      <div class="detail-inner">
        <div class="detail-grid">
          {% for customer in item.customers %}
          <div class="customer-card">
            <div class="customer-card-header">
              <div class="customer-name">
                <i class="fas fa-user"></i>
                {{ customer.customer_name }}
              </div>
            </div>
            <div class="customer-meta">
              {% if customer.customer_code %}
              <span class="customer-meta-item">
                <i class="fas fa-hashtag"></i> Code: {{ customer.customer_code }}
              </span>
              {% endif %}
              <span class="customer-meta-item">
                <i class="fas fa-box"></i> Qty 2025: {% if customer.qty_quoted_2025 %}{{ customer.qty_quoted_2025|floatformat:0|intcomma }}{% else %}—{% endif %}
              </span>
              <span class="customer-meta-item">
                <i class="fas fa-box"></i> Qty 2026: {% if customer.qty_quoted_2026 %}{{ customer.qty_quoted_2026|floatformat:0|intcomma }}{% else %}—{% endif %}
              </span>
              <span class="customer-meta-item">
                <i class="fas fa-file-alt"></i> Quotes 2025: {% if customer.quotation_count_2025 %}{{ customer.quotation_count_2025 }}{% else %}—{% endif %}
              </span>
              <span class="customer-meta-item">
                <i class="fas fa-file-alt"></i> Quotes 2026: {% if customer.quotation_count_2026 %}{{ customer.quotation_count_2026 }}{% else %}—{% endif %}
              </span>
              {% if include_conversion %}
              <span class="customer-meta-item">
                <i class="fas fa-shopping-cart"></i> SO Qty 25: {% if customer.so_qty_2025 %}{{ customer.so_qty_2025|floatformat:0|intcomma }}{% else %}—{% endif %}
              </span>
              <span class="customer-meta-item">
                <i class="fas fa-shopping-cart"></i> SO Qty 26: {% if customer.so_qty_2026 %}{{ customer.so_qty_2026|floatformat:0|intcomma }}{% else %}—{% endif %}
              </span>
              <span class="customer-meta-item">
                <i class="fas fa-check-circle"></i> Convt Quotes 25: {% if customer.converted_quotation_count_2025 %}{{ customer.converted_quotation_count_2025 }}{% else %}0{% endif %}
              </span>
              <span class="customer-meta-item">
                <i class="fas fa-check-circle"></i> Convt Quotes 26: {% if customer.converted_quotation_count_2026 %}{{ customer.converted_quotation_count_2026 }}{% else %}0{% endif %}
              </span>
              {% endif %}
              {% if customer.quotation_numbers %}
              <div style="margin-top: 6px; font-size: 0.7rem; color: var(--text-secondary); width: 100%;">
                <strong>Quote Numbers:</strong> {{ customer.quotation_numbers|join:", " }}
                {% if customer.quotation_count > 10 %}
                  <span style="color: var(--text-muted);">(showing first 10 of {{ customer.quotation_count }})</span>
                {% endif %}
              </div>
              {% endif %}
            </div>
          </div>
          {% empty %}
          <div style="color:var(--text-muted); font-size:0.8125rem; padding:8px;">
            No customer details available.
          </div>
          {% endfor %}
        </div>
      </div>
    </td>
  </tr>
  {% endfor %}
{% else %}
  <tr>
    <td colspan="{% if include_conversion %}16{% else %}10{% endif %}" style="text-align: center; padding: 40px; color: var(--text-muted);">
      <i class="fas fa-inbox" style="font-size: 2rem; margin-bottom: 12px; display: block;"></i>
      <p>No quotation data available</p>
    </td>
  </tr>
{% endif %}
