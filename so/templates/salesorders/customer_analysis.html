{% load humanize %}
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Customer Analysis</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    :root {
      --bg: #f8fafc;
      --surface: #ffffff;
      --text: #1e293b;
      --text-secondary: #64748b;
      --text-muted: #94a3b8;
      --border: #e2e8f0;
      --primary: #3b82f6;
      --primary-dark: #2563eb;
      --primary-light: rgba(59, 130, 246, 0.1);
      --success: #10b981;
      --warning: #f59e0b;
      --danger: #ef4444;
      --radius: 12px;
      --radius-sm: 8px;
      --shadow: 0 1px 3px rgba(0,0,0,0.06), 0 1px 2px rgba(0,0,0,0.04);
      --shadow-md: 0 4px 6px -1px rgba(0,0,0,0.07), 0 2px 4px -1px rgba(0,0,0,0.04);
      --transition: 150ms ease;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    
    body {
      font-family: 'DM Sans', system-ui, -apple-system, sans-serif;
      background: var(--bg);
      color: var(--text);
      line-height: 1.5;
      min-height: 100vh;
    }

    .container {
      max-width: 1800px;
      margin: 0 auto;
      padding: 24px 20px 60px;
    }

    /* Header */
    .header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      flex-wrap: wrap;
      gap: 12px;
      margin-bottom: 16px;
    }

    .header-left h1 {
      font-size: 1.5rem;
      font-weight: 700;
      color: var(--text);
      letter-spacing: -0.02em;
    }

    .header-left p {
      color: var(--text-secondary);
      font-size: 0.813rem;
      margin-top: 2px;
    }

    .header-right {
      display: flex;
      gap: 12px;
    }

    .btn {
      padding: 8px 16px;
      border: none;
      border-radius: var(--radius-sm);
      font-size: 0.813rem;
      font-weight: 500;
      cursor: pointer;
      transition: all var(--transition);
      text-decoration: none;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }

    .btn-primary {
      background: var(--primary);
      color: white;
    }

    .btn-primary:hover {
      background: var(--primary-dark);
    }

    .btn-secondary {
      background: var(--surface);
      color: var(--text);
      border: 1px solid var(--border);
    }

    .btn-secondary:hover {
      background: var(--bg);
    }

    /* Table Card */
    .table-card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
      overflow: hidden;
    }

    .table-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--border);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .table-title {
      font-size: 1.25rem;
      font-weight: 600;
      color: var(--text);
    }

    /* Table */
    .table-wrapper {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: var(--bg);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    th {
      padding: 8px 12px;
      text-align: left;
      font-weight: 600;
      font-size: 0.7rem;
      color: var(--text-secondary);
      text-transform: uppercase;
      letter-spacing: 0.05em;
      border-bottom: 2px solid var(--border);
      white-space: nowrap;
    }

    th.text-right {
      text-align: right;
    }

    tbody tr {
      border-bottom: 1px solid var(--border);
      transition: background var(--transition);
    }

    tbody tr:hover {
      background: var(--bg);
    }

    td {
      padding: 8px 12px;
      font-size: 0.75rem;
      color: var(--text);
    }

    td.text-right {
      text-align: right;
    }

    /* Sticky columns */
    .sticky-col {
      position: sticky;
      background: var(--surface);
      z-index: 5;
      font-weight: 500;
      box-shadow: 2px 0 4px rgba(0,0,0,0.05);
      padding: 6px 8px;
    }

    tbody tr:hover td.sticky-col {
      background: var(--bg);
    }
    
    td.sticky-col:nth-child(2) {
      left: 180px;
    }

    .customer-name {
      color: var(--text-secondary);
      font-size: 0.7rem;
      line-height: 1.3;
      max-width: 180px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-weight: 500;
    }
    
    .customer-code {
      font-size: 0.6rem;
      color: var(--text-muted);
      font-weight: 400;
      margin-top: 2px;
      line-height: 1.2;
    }

    .customer-salesman {
      color: var(--text-secondary);
      font-size: 0.7rem;
      line-height: 1.3;
      max-width: 140px;
      word-wrap: break-word;
      overflow-wrap: break-word;
      font-weight: 500;
    }

    .year-group {
      background: rgba(59, 130, 246, 0.05);
    }
    
    /* Add vertical separator after each year group */
    /* For admin: 2 sticky cols + (Sales, GP, GP%) * 3 years */
    /* Last column of each year: 2 + 3 = 5, 2 + 6 = 8, 2 + 9 = 11 */
    {% if is_admin %}
    /* Vertical line after 2024 (column 5 - last column of 2024) */
    thead th:nth-child(5),
    tbody td:nth-child(5) {
      border-right: 3px solid var(--primary);
    }
    /* Vertical line after 2025 (column 8 - last column of 2025) */
    thead th:nth-child(8),
    tbody td:nth-child(8) {
      border-right: 3px solid var(--primary);
    }
    /* Vertical line before 2024 (column 3 - first column of 2024) */
    thead th:nth-child(3),
    tbody td:nth-child(3) {
      border-left: 3px solid var(--primary);
    }
    /* Vertical line before 2025 (column 6 - first column of 2025) */
    thead th:nth-child(6),
    tbody td:nth-child(6) {
      border-left: 3px solid var(--primary);
    }
    /* Vertical line before 2026 (column 9 - first column of 2026) */
    thead th:nth-child(9),
    tbody td:nth-child(9) {
      border-left: 3px solid var(--primary);
    }
    /* Totals row - apply borders to match regular rows */
    tbody tr.totals-row td:nth-child(5) {
      border-right: 3px solid var(--primary);
    }
    tbody tr.totals-row td:nth-child(8) {
      border-right: 3px solid var(--primary);
    }
    tbody tr.totals-row td:nth-child(3) {
      border-left: 3px solid var(--primary);
    }
    tbody tr.totals-row td:nth-child(6) {
      border-left: 3px solid var(--primary);
    }
    tbody tr.totals-row td:nth-child(9) {
      border-left: 3px solid var(--primary);
    }
    {% else %}
    /* For non-admin: 2 sticky cols + (Sales) * 3 years */
    /* Last column of each year: 2 + 1 = 3, 2 + 2 = 4, 2 + 3 = 5 */
    /* Vertical line after 2024 (column 3) */
    thead th:nth-child(3),
    tbody td:nth-child(3) {
      border-right: 3px solid var(--primary);
    }
    /* Vertical line after 2025 (column 4) */
    thead th:nth-child(4),
    tbody td:nth-child(4) {
      border-right: 3px solid var(--primary);
    }
    /* Vertical line before 2024 (column 3) */
    thead th:nth-child(3),
    tbody td:nth-child(3) {
      border-left: 3px solid var(--primary);
    }
    /* Vertical line before 2025 (column 4) */
    thead th:nth-child(4),
    tbody td:nth-child(4) {
      border-left: 3px solid var(--primary);
    }
    /* Vertical line before 2026 (column 5) */
    thead th:nth-child(5),
    tbody td:nth-child(5) {
      border-left: 3px solid var(--primary);
    }
    /* Totals row */
    tbody tr.totals-row td:nth-child(3) {
      border-right: 3px solid var(--primary);
      border-left: 3px solid var(--primary);
    }
    tbody tr.totals-row td:nth-child(4) {
      border-right: 3px solid var(--primary);
      border-left: 3px solid var(--primary);
    }
    tbody tr.totals-row td:nth-child(5) {
      border-left: 3px solid var(--primary);
    }
    {% endif %}

    /* Card */
    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      box-shadow: var(--shadow);
    }

    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state i {
      font-size: 3rem;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .totals-row {
      background: var(--primary-light);
      border-top: 2px solid var(--primary);
      border-bottom: 2px solid var(--primary);
      font-weight: 700;
    }

    .totals-row td {
      background: var(--primary-light);
      font-weight: 700;
    }

    .totals-row:hover {
      background: var(--primary-light);
    }

    /* Filters */
    .filters-card {
      margin-bottom: 16px;
    }

    .filters-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
      gap: 10px;
      padding: 12px 16px;
    }

    .field {
      display: flex;
      flex-direction: column;
    }

    .field label {
      display: block;
      font-size: 0.75rem;
      font-weight: 500;
      color: var(--text-secondary);
      margin-bottom: 4px;
    }

    /* Multi-select dropdown */
    .multi-select {
      position: relative;
      width: 100%;
    }

    .select-box {
      padding: 6px 10px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      background: var(--surface);
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: space-between;
      font-size: 0.813rem;
      transition: all var(--transition);
    }

    .select-box:hover {
      border-color: var(--primary);
    }

    .select-box::after {
      content: '\f107';
      font-family: 'Font Awesome 6 Free';
      font-weight: 900;
      font-size: 0.75rem;
      color: var(--text-muted);
    }

    .options-container {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      box-shadow: var(--shadow-md);
      max-height: 200px;
      overflow-y: auto;
      z-index: 1000;
      display: none;
      margin-top: 4px;
    }

    .options-container.active {
      display: block;
    }

    .option-label {
      display: block;
      padding: 6px 10px;
      cursor: pointer;
      font-size: 0.813rem;
      transition: background var(--transition);
    }

    .option-label:hover {
      background: var(--bg);
    }

    .option-label input[type="checkbox"] {
      margin-right: 8px;
    }

    /* Search box in dropdown */
    .search-box-container {
      padding: 8px;
      border-bottom: 1px solid var(--border);
      background: var(--surface);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .search-box {
      width: 100%;
      padding: 5px 8px;
      border: 1px solid var(--border);
      border-radius: var(--radius-sm);
      font-size: 0.75rem;
      font-family: inherit;
      background: var(--bg);
      color: var(--text);
    }

    .search-box:focus {
      outline: none;
      border-color: var(--primary);
      box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.1);
    }

    .options-list {
      max-height: 200px;
      overflow-y: auto;
    }

    .option-label.hidden {
      display: none;
    }

    /* Store Filter Tiles */
    .store-tile {
      display: inline-block;
      padding: 5px 12px;
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-size: 0.75rem;
      font-weight: 500;
      transition: all var(--transition);
      border: 2px solid var(--border);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
    }

    .store-tile:hover {
      border-color: var(--primary);
      background: var(--primary-light);
      color: var(--primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .store-tile.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow);
    }

    /* Month Filter Tiles */
    .month-tile {
      display: inline-block;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      text-decoration: none;
      font-size: 0.7rem;
      font-weight: 500;
      transition: all var(--transition);
      border: 2px solid var(--border);
      background: var(--surface);
      color: var(--text);
      cursor: pointer;
    }

    .month-tile:hover {
      border-color: var(--primary);
      background: var(--primary-light);
      color: var(--primary);
      transform: translateY(-1px);
      box-shadow: var(--shadow);
    }

    .month-tile.active {
      border-color: var(--primary);
      background: var(--primary);
      color: white;
      box-shadow: var(--shadow);
    }

    @media (max-width: 768px) {
      .container {
        padding: 16px 12px 40px;
      }
      
      .header {
        flex-direction: column;
        align-items: flex-start;
      }
      
      .table-wrapper {
        font-size: 0.813rem;
      }
      
      th, td {
        padding: 8px 12px;
      }
    }
    /* Loading Overlay */
    .loading-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(255, 255, 255, 0.95);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 9999;
      transition: opacity 0.3s ease, visibility 0.3s ease;
    }

    .loading-overlay.hidden {
      opacity: 0;
      visibility: hidden;
    }

    .loading-spinner {
      width: 50px;
      height: 50px;
      border: 4px solid var(--border);
      border-top-color: var(--primary);
      border-radius: 50%;
      animation: spin 1s linear infinite;
    }

    @keyframes spin {
      to {
        transform: rotate(360deg);
      }
    }

    .loading-text {
      margin-top: 16px;
      font-size: 0.875rem;
      color: var(--text-secondary);
      font-weight: 500;
    }

    .loading-content {
      display: flex;
      flex-direction: column;
      align-items: center;
    }
  </style>
</head>
<body>
  <!-- Loading Overlay -->
  <div class="loading-overlay" id="loading-overlay">
    <div class="loading-content">
      <div class="loading-spinner"></div>
      <div class="loading-text">Loading Customer Analysis...</div>
    </div>
  </div>

  <div class="container">
    <!-- Header -->
    <div class="header">
      <div class="header-left">
        <h1>Customer Analysis</h1>
        <p>Comprehensive customer performance analysis by year</p>
      </div>
      <div class="header-right">
        <a href="{% url 'item_analysis' %}" class="btn btn-secondary">
          <i class="fas fa-chart-bar"></i>
          Item Analysis
        </a>
        <a href="{% url 'home' %}" class="btn btn-secondary">
          <i class="fas fa-arrow-left"></i>
          Back
        </a>
      </div>
    </div>

    <!-- Store Filter Tiles -->
    <div class="card" style="margin-bottom: 20px; padding: 16px 20px;">
      <div style="display: flex; align-items: center; gap: 12px; flex-wrap: wrap;">
        <label style="font-size: 0.875rem; font-weight: 500; color: var(--text-secondary); margin-right: 8px;">Store:</label>
        <button type="button" class="store-tile {% if not filters.store %}active{% endif %}" data-store="">
          All Stores
        </button>
        <button type="button" class="store-tile {% if filters.store == 'HO' %}active{% endif %}" data-store="HO">
          HO
        </button>
        <button type="button" class="store-tile {% if filters.store == 'Others' %}active{% endif %}" data-store="Others">
          Others
        </button>
      </div>
    </div>

    <!-- Category Filter Tiles -->
    <div class="card" style="margin-bottom: 12px; padding: 10px 14px;">
      <div style="display: flex; align-items: center; gap: 8px; flex-wrap: wrap;">
        <label style="font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-right: 6px;">Category:</label>
        <button type="button" class="store-tile {% if filters.category == 'All' or not filters.category %}active{% endif %}" data-category="All">
          All Categories
        </button>
        <button type="button" class="store-tile {% if filters.category == 'Project' %}active{% endif %}" data-category="Project">
          Project
        </button>
        <button type="button" class="store-tile {% if filters.category == 'Trading' %}active{% endif %}" data-category="Trading">
          Trading
        </button>
        <button type="button" class="store-tile {% if filters.category == 'Export' %}active{% endif %}" data-category="Export">
          Export
        </button>
        <button type="button" class="store-tile {% if filters.category == 'Retail' %}active{% endif %}" data-category="Retail">
          Retail
        </button>
        <button type="button" class="store-tile {% if filters.category == 'Others' %}active{% endif %}" data-category="Others">
          Others
        </button>
        <input type="hidden" name="category" id="category-input" value="{{ filters.category|default:'All' }}">
      </div>
    </div>

    <!-- Month Filter Tiles -->
    <div class="card" style="margin-bottom: 12px; padding: 10px 14px;">
      <div style="display: flex; align-items: center; gap: 6px; flex-wrap: wrap;">
        <label style="font-size: 0.75rem; font-weight: 500; color: var(--text-secondary); margin-right: 6px;">Month:</label>
        <button type="button" class="month-tile {% if '1' in filters.month %}active{% endif %}" data-month="1">Jan</button>
        <button type="button" class="month-tile {% if '2' in filters.month %}active{% endif %}" data-month="2">Feb</button>
        <button type="button" class="month-tile {% if '3' in filters.month %}active{% endif %}" data-month="3">Mar</button>
        <button type="button" class="month-tile {% if '4' in filters.month %}active{% endif %}" data-month="4">Apr</button>
        <button type="button" class="month-tile {% if '5' in filters.month %}active{% endif %}" data-month="5">May</button>
        <button type="button" class="month-tile {% if '6' in filters.month %}active{% endif %}" data-month="6">Jun</button>
        <button type="button" class="month-tile {% if '7' in filters.month %}active{% endif %}" data-month="7">Jul</button>
        <button type="button" class="month-tile {% if '8' in filters.month %}active{% endif %}" data-month="8">Aug</button>
        <button type="button" class="month-tile {% if '9' in filters.month %}active{% endif %}" data-month="9">Sep</button>
        <button type="button" class="month-tile {% if '10' in filters.month %}active{% endif %}" data-month="10">Oct</button>
        <button type="button" class="month-tile {% if '11' in filters.month %}active{% endif %}" data-month="11">Nov</button>
        <button type="button" class="month-tile {% if '12' in filters.month %}active{% endif %}" data-month="12">Dec</button>
      </div>
    </div>

    <!-- Filters Card -->
    <div class="card filters-card">
      <form method="GET" action="{% url 'customer_analysis' %}" id="filters-form">
        <input type="hidden" name="store" id="store-input" value="{{ filters.store }}">
        <div class="filters-grid">
          <div class="field">
            <label>Search</label>
            <input type="text" name="q" id="search-input" value="{{ filters.q }}" placeholder="Customer Code or Name" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.813rem; font-family: inherit;">
          </div>
          <div class="field">
            <label>Salesman</label>
            <div class="multi-select" id="salesman-wrapper">
              <div class="select-box" id="salesman-trigger">
                <span id="salesman-text">All Salesmen</span>
              </div>
              <div class="options-container" id="salesman-options">
                <div class="search-box-container">
                  <input type="text" id="salesman-search" class="search-box" placeholder="Search salesmen..." autocomplete="off">
                </div>
                <div class="options-list" id="salesman-options-list">
                  {% for salesman in salesmen %}
                    <label class="option-label" data-value="{{ salesman }}">
                      <input type="checkbox" name="salesman" value="{{ salesman }}" {% if salesman in filters.salesman %}checked{% endif %}>
                      <span class="option-text">{{ salesman }}</span>
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          <div class="field">
            <label>Firm</label>
            <div class="multi-select" id="firm-wrapper">
              <div class="select-box" id="firm-trigger">
                <span id="firm-text">All Firms</span>
              </div>
              <div class="options-container" id="firm-options">
                <div class="search-box-container">
                  <input type="text" id="firm-search" class="search-box" placeholder="Search firms..." autocomplete="off">
                </div>
                <div class="options-list" id="firm-options-list">
                  {% for firm in firms %}
                    <label class="option-label" data-value="{{ firm }}">
                      <input type="checkbox" name="firm" value="{{ firm }}" {% if firm in filters.firm %}checked{% endif %}>
                      <span class="option-text">{{ firm }}</span>
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          <div class="field">
            <label>Item</label>
            <div class="multi-select" id="item-wrapper">
              <div class="select-box" id="item-trigger">
                <span id="item-text">All Items</span>
              </div>
              <div class="options-container" id="item-options">
                <div class="search-box-container">
                  <input type="text" id="item-search" class="search-box" placeholder="Search by Item Code, Name, or UPC..." autocomplete="off">
                </div>
                <div class="options-list" id="item-options-list">
                  {% for item in items %}
                    <label class="option-label" data-value="{{ item.code }}" data-description="{{ item.description|default:''|lower }}" data-upc="{{ item.upc|default:''|lower }}">
                      <input type="checkbox" name="item" value="{{ item.code }}" {% if item.code in filters.item %}checked{% endif %}>
                      <span class="option-text">
                        <strong>{{ item.code }}</strong>
                        {% if item.description %}
                        <span style="color: var(--text-muted); font-size: 0.75rem;"> - {{ item.description }}</span>
                        {% endif %}
                        {% if item.upc %}
                        <span style="color: var(--text-muted); font-size: 0.7rem; display: block; margin-top: 2px;">UPC: {{ item.upc }}</span>
                        {% endif %}
                      </span>
                    </label>
                  {% endfor %}
                </div>
              </div>
            </div>
          </div>
          <div class="field">
            <label>Start Date</label>
            <input type="date" name="start" id="start-date" value="{{ filters.start }}" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.813rem; font-family: inherit;">
          </div>
          <div class="field">
            <label>End Date</label>
            <input type="date" name="end" id="end-date" value="{{ filters.end }}" style="width: 100%; padding: 6px 10px; border: 1px solid var(--border); border-radius: var(--radius-sm); font-size: 0.813rem; font-family: inherit;">
          </div>
          <div class="field" style="display: flex; gap: 6px; align-self:end;">
            <button class="btn btn-secondary" type="button" id="clear-filters" style="padding: 6px 14px; font-size: 0.813rem;">Clear</button>
            <button class="btn btn-primary" type="button" id="apply-filters" style="padding: 6px 14px; font-size: 0.813rem;">Apply</button>
          </div>
        </div>
      </form>
    </div>

    <!-- Table Card -->
    <div class="table-card">
      <div class="table-header">
        <h3 class="table-title">Customer Performance Matrix</h3>
      </div>
      <div class="table-wrapper">
        <table>
          <thead>
            <tr>
              <th class="sticky-col" style="min-width: 180px;">Customer Name</th>
              <th class="sticky-col" style="min-width: 140px; left: 180px;">Salesman Name</th>
              {% for year in years %}
              <th colspan="{% if is_admin %}3{% else %}1{% endif %}" class="year-group text-right" style="text-align: center;">{{ year }}</th>
              {% endfor %}
            </tr>
            <tr>
              <th class="sticky-col" style="left: 0;"></th>
              <th class="sticky-col" style="left: 180px;"></th>
              {% for year in years %}
              <th class="text-right">Sales</th>
              {% if is_admin %}<th class="text-right">GP</th>{% endif %}
              {% if is_admin %}<th class="text-right">GP%</th>{% endif %}
              {% endfor %}
            </tr>
          </thead>
          <tbody id="table-body">
            <!-- Totals Row -->
            <tr class="totals-row">
              <td class="sticky-col" style="left: 0; font-weight: 700; background: var(--primary-light);">TOTAL</td>
              <td class="sticky-col" style="left: 180px; font-weight: 700; background: var(--primary-light);"></td>
              {% for totals in totals_list %}
                <td class="text-right totals-cell" style="font-weight: 700; background: var(--primary-light);">{{ totals.total_sales|default:0|floatformat:2|intcomma }}</td>
                {% if is_admin %}<td class="text-right totals-cell" style="font-weight: 700; background: var(--primary-light);">{{ totals.total_gp|default:0|floatformat:2|intcomma }}</td>{% endif %}
                {% if is_admin %}<td class="text-right totals-cell" style="font-weight: 700; background: var(--primary-light);">{{ totals.total_gp_percent|default:0|floatformat:2 }}%</td>{% endif %}
              {% endfor %}
            </tr>
            {% for customer in customers %}
            <tr>
              <td class="sticky-col" style="left: 0;">
                <div class="customer-name">{{ customer.customer_name|default:"Unknown" }}</div>
                {% if customer.customer_code %}
                <div class="customer-code">{{ customer.customer_code }}</div>
                {% endif %}
              </td>
              <td class="sticky-col customer-salesman" style="left: 180px;">{{ customer.salesman_name|default:"â€”" }}</td>
              {% for year_data in customer.year_list %}
                <td class="text-right">{{ year_data.total_sales|default:0|floatformat:2|intcomma }}</td>
                {% if is_admin %}<td class="text-right">{{ year_data.total_gp|default:0|floatformat:2|intcomma }}</td>{% endif %}
                {% if is_admin %}<td class="text-right">{{ year_data.gp_percent|default:0|floatformat:2 }}%</td>{% endif %}
              {% endfor %}
            </tr>
            {% empty %}
            <tr>
              <td colspan="{% widthratio years|length 1 3 %}" class="empty-state">
                <i class="fas fa-inbox"></i>
                <p>No customer data available</p>
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
      
      <!-- Pagination and Count -->
      <div id="pagination-container">
        {% if page_obj.paginator.num_pages > 1 %}
          {% include 'salesorders/_pagination.html' with page_obj=page_obj %}
        {% endif %}
      </div>
      <div class="total-count" style="margin-top: 16px; text-align: center; color: var(--text-secondary); font-size: 0.875rem;">
        Showing <strong>{{ page_obj|length }}</strong> of <strong>{{ total_count|intcomma }}</strong> customers
      </div>
    </div>
  </div>

  <script>
    // Hide loading overlay when page is fully loaded
    window.addEventListener('load', function() {
      const loadingOverlay = document.getElementById('loading-overlay');
      if (loadingOverlay) {
        setTimeout(() => {
          loadingOverlay.classList.add('hidden');
          setTimeout(() => {
            loadingOverlay.remove();
          }, 300);
        }, 300);
      }
    });

    // Multi-Select for Salesman
    document.addEventListener("DOMContentLoaded", function() {
      const salesmanWrapper = document.getElementById('salesman-wrapper');
      const salesmanTrigger = document.getElementById('salesman-trigger');
      const salesmanOptions = document.getElementById('salesman-options');
      const salesmanOptionsList = document.getElementById('salesman-options-list');
      const salesmanText = document.getElementById('salesman-text');
      const salesmanSearch = document.getElementById('salesman-search');
      const getSalesmanCheckboxes = () => salesmanOptionsList.querySelectorAll('input[type="checkbox"]');
      const getSalesmanLabels = () => salesmanOptionsList.querySelectorAll('.option-label');

      salesmanTrigger.addEventListener('click', e => {
        e.stopPropagation();
        salesmanOptions.classList.toggle('active');
        if (salesmanOptions.classList.contains('active')) {
          setTimeout(() => salesmanSearch.focus(), 100);
        } else {
          salesmanSearch.value = '';
          getSalesmanLabels().forEach(label => label.classList.remove('hidden'));
        }
      });

      salesmanOptions.addEventListener('click', e => e.stopPropagation());

      salesmanSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const labels = getSalesmanLabels();
        
        labels.forEach(label => {
          const text = label.querySelector('.option-text').textContent.toLowerCase();
          if (text.includes(searchTerm)) {
            label.classList.remove('hidden');
          } else {
            label.classList.add('hidden');
          }
        });
      });

      salesmanSearch.addEventListener('click', e => e.stopPropagation());

      function updateSalesmanLabel() {
        const checked = Array.from(getSalesmanCheckboxes()).filter(c => c.checked);
        if (checked.length === 0) {
          salesmanText.textContent = "All Salesmen";
          salesmanText.style.opacity = "0.6";
        } else if (checked.length === 1) {
          salesmanText.textContent = checked[0].value;
          salesmanText.style.opacity = "1";
        } else {
          salesmanText.textContent = `${checked.length} Selected`;
          salesmanText.style.opacity = "1";
        }
      }

      updateSalesmanLabel();

      getSalesmanCheckboxes().forEach(box => {
        box.addEventListener('change', function() {
          updateSalesmanLabel();
        });
      });

      document.addEventListener('click', e => {
        if (!salesmanWrapper.contains(e.target)) salesmanOptions.classList.remove('active');
      });

      // Multi-Select for Firm
      const firmWrapper = document.getElementById('firm-wrapper');
      const firmTrigger = document.getElementById('firm-trigger');
      const firmOptions = document.getElementById('firm-options');
      const firmOptionsList = document.getElementById('firm-options-list');
      const firmText = document.getElementById('firm-text');
      const firmSearch = document.getElementById('firm-search');
      const getFirmCheckboxes = () => firmOptionsList.querySelectorAll('input[type="checkbox"]');
      const getFirmLabels = () => firmOptionsList.querySelectorAll('.option-label');

      firmTrigger.addEventListener('click', e => {
        e.stopPropagation();
        firmOptions.classList.toggle('active');
        if (firmOptions.classList.contains('active')) {
          setTimeout(() => firmSearch.focus(), 100);
        } else {
          firmSearch.value = '';
          getFirmLabels().forEach(label => label.classList.remove('hidden'));
        }
      });

      firmOptions.addEventListener('click', e => e.stopPropagation());

      firmSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const labels = getFirmLabels();
        
        labels.forEach(label => {
          const text = label.querySelector('.option-text').textContent.toLowerCase();
          if (text.includes(searchTerm)) {
            label.classList.remove('hidden');
          } else {
            label.classList.add('hidden');
          }
        });
      });

      firmSearch.addEventListener('click', e => e.stopPropagation());

      function updateFirmLabel() {
        const checked = Array.from(getFirmCheckboxes()).filter(c => c.checked);
        if (checked.length === 0) {
          firmText.textContent = "All Firms";
          firmText.style.opacity = "0.6";
        } else if (checked.length === 1) {
          firmText.textContent = checked[0].value;
          firmText.style.opacity = "1";
        } else {
          firmText.textContent = `${checked.length} Selected`;
          firmText.style.opacity = "1";
        }
      }

      updateFirmLabel();

      getFirmCheckboxes().forEach(box => {
        box.addEventListener('change', function() {
          updateFirmLabel();
        });
      });

      document.addEventListener('click', e => {
        if (!firmWrapper.contains(e.target)) firmOptions.classList.remove('active');
      });

      // Multi-Select for Item
      const itemWrapper = document.getElementById('item-wrapper');
      const itemTrigger = document.getElementById('item-trigger');
      const itemOptions = document.getElementById('item-options');
      const itemOptionsList = document.getElementById('item-options-list');
      const itemText = document.getElementById('item-text');
      const itemSearch = document.getElementById('item-search');
      const getItemCheckboxes = () => itemOptionsList.querySelectorAll('input[type="checkbox"]');
      const getItemLabels = () => itemOptionsList.querySelectorAll('.option-label');

      itemTrigger.addEventListener('click', e => {
        e.stopPropagation();
        itemOptions.classList.toggle('active');
        if (itemOptions.classList.contains('active')) {
          setTimeout(() => itemSearch.focus(), 100);
        } else {
          itemSearch.value = '';
          getItemLabels().forEach(label => label.classList.remove('hidden'));
        }
      });

      itemOptions.addEventListener('click', e => e.stopPropagation());

      itemSearch.addEventListener('input', function() {
        const searchTerm = this.value.toLowerCase().trim();
        const labels = getItemLabels();
        
        labels.forEach(label => {
          const code = label.getAttribute('data-value') || '';
          const description = label.getAttribute('data-description') || '';
          const upc = label.getAttribute('data-upc') || '';
          
          // Search in code, description, or UPC
          if (code.toLowerCase().includes(searchTerm) || 
              description.includes(searchTerm) || 
              upc.includes(searchTerm)) {
            label.classList.remove('hidden');
          } else {
            label.classList.add('hidden');
          }
        });
      });

      itemSearch.addEventListener('click', e => e.stopPropagation());

      function updateItemLabel() {
        const checked = Array.from(getItemCheckboxes()).filter(c => c.checked);
        if (checked.length === 0) {
          itemText.textContent = "All Items";
          itemText.style.opacity = "0.6";
        } else if (checked.length === 1) {
          itemText.textContent = checked[0].value;
          itemText.style.opacity = "1";
        } else {
          itemText.textContent = `${checked.length} Selected`;
          itemText.style.opacity = "1";
        }
      }

      updateItemLabel();

      getItemCheckboxes().forEach(box => {
        box.addEventListener('change', function() {
          updateItemLabel();
        });
      });

      document.addEventListener('click', e => {
        if (!itemWrapper.contains(e.target)) itemOptions.classList.remove('active');
      });

      // Store filter tiles
      const storeTiles = document.querySelectorAll('.store-tile[data-store]');
      const storeInput = document.getElementById('store-input');
      
      storeTiles.forEach(tile => {
        tile.addEventListener('click', function() {
          storeTiles.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          if (storeInput) {
            storeInput.value = this.dataset.store || '';
          }
        });
      });

      // Category filter tiles
      const categoryTiles = document.querySelectorAll('.store-tile[data-category]');
      const categoryInput = document.getElementById('category-input');
      
      categoryTiles.forEach(tile => {
        tile.addEventListener('click', function() {
          categoryTiles.forEach(t => t.classList.remove('active'));
          this.classList.add('active');
          if (categoryInput) {
            categoryInput.value = this.dataset.category || 'All';
          }
        });
      });

      // Month filter tiles (multi-select - no page refresh, just toggle)
      const monthTiles = document.querySelectorAll('.month-tile');
      
      monthTiles.forEach(tile => {
        tile.addEventListener('click', function() {
          this.classList.toggle('active');
        });
      });

      // Apply filters button - AJAX version
      const applyBtn = document.getElementById('apply-filters');
      const filtersForm = document.getElementById('filters-form');
      
      applyBtn.addEventListener('click', function() {
        const formData = new FormData(filtersForm);
        const params = new URLSearchParams();
        
        // Add all form fields
        for (const [key, value] of formData.entries()) {
          if (key === 'salesman' || key === 'firm' || key === 'item' || key === 'month') {
            params.append(key, value);
          } else if (value) {
            params.set(key, value);
          }
        }
        
        // Add selected months from tiles
        monthTiles.forEach(tile => {
          if (tile.classList.contains('active')) {
            params.append('month', tile.dataset.month);
          }
        });
        
        // Add category filter
        if (categoryInput && categoryInput.value) {
          params.set('category', categoryInput.value);
        }
        
        // Show loading overlay
        const loadingOverlay = document.getElementById('loading-overlay');
        if (loadingOverlay) {
          loadingOverlay.classList.remove('hidden');
        }
        
        // Make AJAX request
        fetch('{% url "customer_analysis" %}?' + params.toString() + '&ajax=1', {
          method: 'GET',
          headers: {
            'X-Requested-With': 'XMLHttpRequest'
          }
        })
        .then(response => response.json())
        .then(data => {
          if (data.success) {
            // Update table body
            const tableBody = document.getElementById('table-body');
            if (tableBody && data.table_html) {
              tableBody.innerHTML = data.table_html;
            }
            
            // Update pagination
            const paginationContainer = document.getElementById('pagination-container');
            if (paginationContainer && data.pagination_html) {
              paginationContainer.innerHTML = data.pagination_html;
            }
            
            // Update total count
            const totalCountEl = document.querySelector('.total-count');
            if (totalCountEl) {
              totalCountEl.innerHTML = `Showing <strong>${data.customers_count}</strong> of <strong>${data.total_count.toLocaleString()}</strong> customers`;
            }
            
            // Update URL without reload
            window.history.pushState({}, '', '{% url "customer_analysis" %}?' + params.toString());
          } else {
            console.error('Error:', data.error);
            // Fallback to page reload
            window.location.href = '{% url "customer_analysis" %}?' + params.toString();
          }
        })
        .catch(error => {
          console.error('Error:', error);
          // Fallback to page reload
          window.location.href = '{% url "customer_analysis" %}?' + params.toString();
        })
        .finally(() => {
          // Hide loading overlay
          if (loadingOverlay) {
            loadingOverlay.classList.add('hidden');
          }
        });
      });

      // Clear filters button
      const clearBtn = document.getElementById('clear-filters');
      clearBtn.addEventListener('click', function() {
        window.location.href = '{% url "customer_analysis" %}';
      });

      // Pagination handling - preserve all filters when navigating pages
      document.addEventListener('click', function(e) {
        const paginationLink = e.target.closest('a[data-page]');
        if (paginationLink) {
          e.preventDefault();
          
          // Get current URL parameters
          const currentParams = new URLSearchParams(window.location.search);
          
          // Update page number
          currentParams.set('page', paginationLink.getAttribute('data-page'));
          
          // Show loading overlay
          const loadingOverlay = document.getElementById('loading-overlay');
          if (loadingOverlay) {
            loadingOverlay.classList.remove('hidden');
          }
          
          // Make AJAX request
          fetch('{% url "customer_analysis" %}?' + currentParams.toString() + '&ajax=1', {
            method: 'GET',
            headers: {
              'X-Requested-With': 'XMLHttpRequest'
            }
          })
          .then(response => response.json())
          .then(data => {
            if (data.success) {
              // Update table body
              const tableBody = document.getElementById('table-body');
              if (tableBody && data.table_html) {
                tableBody.innerHTML = data.table_html;
              }
              
              // Update pagination
              const paginationContainer = document.getElementById('pagination-container');
              if (paginationContainer && data.pagination_html) {
                paginationContainer.innerHTML = data.pagination_html;
              }
              
              // Update total count
              const totalCountEl = document.querySelector('.total-count');
              if (totalCountEl) {
                totalCountEl.innerHTML = `Showing <strong>${data.customers_count}</strong> of <strong>${data.total_count.toLocaleString()}</strong> customers`;
              }
              
              // Update URL without reload
              window.history.pushState({}, '', '{% url "customer_analysis" %}?' + currentParams.toString());
            } else {
              console.error('Error:', data.error);
              window.location.href = '{% url "customer_analysis" %}?' + currentParams.toString();
            }
          })
          .catch(error => {
            console.error('Error:', error);
            window.location.href = '{% url "customer_analysis" %}?' + currentParams.toString();
          })
          .finally(() => {
            // Hide loading overlay
            if (loadingOverlay) {
              loadingOverlay.classList.add('hidden');
            }
          });
        }
      });
    });
  </script>
</body>
</html>
